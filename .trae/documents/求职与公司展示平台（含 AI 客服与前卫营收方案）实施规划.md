## 目标
- 为个人与公司提供安全、便捷的第三方登录/注册，覆盖国内与国际常见身份提供方。
- 与“不骚扰用户”“公司认证与职位合规”“VC/YC 融资合作”“分挡计费”“主题/皮肤市集”等既有方案无缝集成。

## 支持的身份提供方（可按区域开关）
- 国内：微信/企业微信、钉钉、支付宝、微博。
- 国际：Apple、Google、GitHub、LinkedIn、Microsoft（Azure AD/个人）。
- 扩展：Passkeys（WebAuthn）与 TOTP 双因素；后续支持手机号一键登录（短信/本机号校验）。

## 登录/注册流程（OIDC Code Flow＋PKCE）
- 发起：用户选择“使用 X 登录”，后端生成 `state` 与 `nonce`，前端携带 PKCE `code_challenge` 跳转。
- 回调：校验 `state`/`nonce`，使用 `code_verifier` 交换令牌；从 ID Token/用户信息端点获取最小必要字段（email/头像/昵称/唯一标识）。
- 账户绑定：
  - 自动：同一“已验证邮箱”命中时合并到现有账户（需用户确认）。
  - 手动：用户在“账户与安全”页绑定/解绑多个身份提供方；避免重复账户。
  - 微信等无邮箱场景：以 `unionid/openid` 作为唯一键，必要时引导补充邮箱/手机号。
- 首次登录补充：最少必填（地区/语言/隐私与条款同意），不强制社交图谱授权。
- 会话与令牌：短寿命访问令牌＋滚动刷新令牌（哈希存储与撤销）；全站会话 Cookie `httpOnly/Secure/SameSite=Lax`；关键操作二次验证。

## 权限与数据最小化
- Scopes：仅请求 email/profile 基础信息；显式拒绝通讯录/好友列表/无限权限。
- 数据最小化：不采集不必要字段；令牌与用户信息按需缓存，定期轮转与清理；合规目的/保留周期可视化。

## 反骚扰与通信控制
- 默认静默：第三方登录后不自动关注、不推送营销；仅必要交易类消息（安全/账户）。
- 细粒度订阅：频道（站内/邮件/推送/SMS）× 类别（交易/关系/推荐/融资）独立开关；Digest 汇总可选。
- 频率/安静时段：每日/每周限频；安静时段默认禁止非必要触达；一键勿扰模式。

## 公司认证与职位合规联动
- 公司侧：完成 KYB（执照/域名/企业邮箱）后才可发布职位与开放 API；认证等级绑定权限。
- 职位发布：结构化表单＋规则/AI 预审＋人工复核队列；违规拒绝并给出整改建议与申诉通道。
- 动态/视频：媒体预审与分级发布、水印与溯源、举报与下架流程；区域合规与年龄分级可选。

## VC/YC 模块联动
- 投资人档案与预约时段；创业者 Pitch 页面与私密数据室（水印/审计/NDA 可选）。
- 双重同意引荐与批次申请；AI 匹配可解释且可关闭推荐触达。

## 计费与用量协同
- 文件空间分挡：免费基线（示例：2GB 存储、5GB/月带宽、60 分钟/月转码）+ 容量包（一次性）+ 超额按用量确认计费。
- 职位分档：免费最多 2 个有效职位；5/20/50/100 配额包或并发槽位模式；到期续期需显式确认。
- 主题/皮肤：一口价/限时包，创作者分成（封顶与阶梯下调），性能与可访问性预算强校验。

## 安全与合规
- 防护：CSRF、PKCE、`state/nonce`、速率限制、设备指纹轻量化、登录风控与异常提醒（低扰）。
- 合规：GDPR/CCPA/PIPL；法律基础记录（同意/合同/合法利益）、审计日志与撤回生效；数据导出/删除权利。

## 数据模型（概要）
- `User`/`Profile`；`IdentityProvider`/`UserIdentity`（provider/subject/verifiedEmail/linkedAt）；
- `Session`/`RefreshToken`（哈希与撤销表）；`NotificationPreference`/`NotificationEvent`/`InboxItem`；
- 认证与合规：`CompanyVerification`、`JobCompliance`、`ContentModeration`；
- 用量与计费：`UsageMeter`、`Quota`、`CapacityPack`、`ChargeRecord`。

## 前端与后端实现要点
- 前端：统一登录面板（按钮顺序按区域动态调整）、回调状态提示、首次补充信息引导；WebAuthn/Passkeys 可选。
- 后端：Provider SDK/OIDC 标准化适配层（国内与国际）、令牌安全存储与轮转、账户合并逻辑、异常与风控。
- 运维：重定向 URI 白名单、密钥管理（环境变量）、灰度与金丝雀、可观察性与告警（低扰）。

## MVP 交付
- 第三方登录：微信/Apple/Google/GitHub/LinkedIn（首批）；国内企业侧优先企业微信/钉钉；
- 账户绑定/合并、首次补充信息、会话管理与登出；
- 通信偏好与勿扰设置；公司认证与职位/媒体合规的最小可用版本；
- 用量与计费仪表盘、职位配额包与容量包基础购买与明细；
- 主题/皮肤官方 3–5 款与样式 token 架构。

## 验收指标
- 登录成功率（>98%）、平均回调耗时、Provider 异常重试成功率；
- 账户重复率降低（自动/手动合并有效）、申诉满意度；
- 非交易消息违规触达≈0、安静时段违规为零；
- 合规拦截与申诉平衡、计费透明度与争议率低；
- 性能与可访问性达标，主题安装不降级。